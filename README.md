# SmartCollectAPI

SmartCollectAPI is an asynchronous document-processing pipeline. Uploads are accepted by a .NET 9 API, enriched by a dedicated spaCy NLP microservice, and persisted into PostgreSQL with pgvector for downstream semantic search.

## Current Capabilities

- Ingest single or bulk files through `/api/ingest` and `/api/ingest/bulk`
- SHA-256 deduplication and staging-tracking via PostgreSQL tables
- MIME detection, structured-data parsing (JSON, XML, CSV), and PDF parsing with PdfPig
- LibreOffice-backed conversion for Office formats (DOCX/XLSX/PPTX/RTF/ODF) into PDF prior to parsing
- Tesseract CLI integration for image OCR (JPEG/PNG/GIF/BMP/TIFF) with configurable language packs
- Entity extraction and embeddings generated by the `micros/spaCy` FastAPI service
- Background workers that pull jobs from Redis and persist canonical documents plus vectors
- Health checks for Postgres, Redis, and the API (`/health`, `/health/basic`)
- Next.js dashboard for uploads and health monitoring (optional during development)

## Components at a Glance

| Component | Location | Purpose |
| --- | --- | --- |
| ASP.NET Core API | `Server/` | Handles uploads, queues jobs, exposes document and query endpoints |
| spaCy NLP Service | `micros/spaCy/` | FastAPI app that returns entities, sentiment, key phrases, and 96-dim embeddings |
| Redis | Docker service | Backing queue for ingestion and worker coordination |
| PostgreSQL + pgvector | Docker service | Stores staging metadata, canonical documents, and embeddings |
| Next.js Client | `client/` | Developer dashboard (health + upload) |

### Optional / In-progress

- Audio transcription via Whisper/faster-whisper sidecar for WAV/MP3/MP4 inputs
- Archive expansion service (ZIP/TAR) with recursive ingestion
- Vector similarity search endpoint (existing) to be extended with chunked embeddings and filters

## Processing Flow

1. **Upload** – File lands in local storage (`uploads/`) via `LocalStorageService`.
2. **Queue** – `RedisJobQueue` pushes a `JobEnvelope` onto Redis.
3. **Workers** – Hosted services (`IngestWorker`, `RedisDataConsumer`) pull jobs, parse content, and call the spaCy service.
4. **Enrichment** – `DocumentProcessingPipeline` combines parser output, NLP enrichment, and embeddings into a canonical document.
5. **Persist** – Canonical JSON plus vectors are written to the `documents` table; staging records capture lifecycle metadata.
6. **Access** – REST endpoints under `/api/documents` expose summaries, details, staging status, and similarity queries.

## Prerequisites (Linux-friendly)

- LibreOffice (provides `soffice` CLI) for Office document conversion
- Tesseract OCR (`tesseract` CLI) plus language packs (default `eng`)
- Python 3.11+ with spaCy requirements (see `micros/spaCy/requirements.txt`)
- Docker Compose (optional) to launch Redis/Postgres/pgvector supporting services

## Getting Started

1. **Boot supporting services**

```powershell
docker compose -f docker-compose.dev.yml up -d
```

2. **(Recommended) Create and activate a Python virtual environment**

```powershell
cd micros\spaCy
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
python -m spacy download en_core_web_sm
```

3. **Run the spaCy microservice (required for embeddings and entities)**

```powershell
cd micros\spaCy
python -m uvicorn app:app --host 0.0.0.0 --port 5084 --reload
```

You can alternatively use the helper script `run.bat` on Windows or `run.sh` on macOS/Linux.

4. **Start the .NET API**

```powershell
cd Server
dotnet run
```

The API listens on `http://localhost:5082` (or `https://localhost:7129` if you choose the HTTPS profile).

5. **(Optional) Start the Next.js dashboard**

```powershell
cd client
npm install
npm run dev
```

Set `NEXT_PUBLIC_API_BASE` in `client/.env.local` if you need to target a different API host.

## Configuration Overview

- `Server/appsettings.Development.json` controls Redis/Postgres connections, storage provider, and which service implementations the pipeline uses.
- `micros/spaCy/.env` (optional) lets you override Redis host, model name, and feature flags for the NLP service.
- `Services` configuration values choose the parser, OCR, embedding, entity extraction, and notification providers (supported values today: `OSS` and `SIMPLE`).
- `LibreOffice` configures the CLI path and timeout for Office document conversion.
- `Tesseract` configures binary path, languages, and timeout for OCR.

### Sample service configuration

```jsonc
{
  "ConnectionStrings": {
    "Redis": "localhost:6379",
    "Postgres": "Host=localhost;Port=5433;Database=smartcollect;Username=postgres;Password=postgres"
  },
  "Services": {
    "Parser": "OSS",
    "OCR": "OSS",
    "Embeddings": "OSS",
    "EntityExtraction": "OSS",
    "Notifications": "OSS"
  },
  "LibreOffice": {
    "Enabled": true,
    "BinaryPath": "soffice",
    "TimeoutSeconds": 120
  },
  "Tesseract": {
    "Enabled": true,
    "BinaryPath": "tesseract",
    "Languages": "eng",
    "TimeoutSeconds": 120
  }
}
```

Switching `Parser` to `SIMPLE` opts into the more lightweight `SimplePdfParser`; leaving it as `OSS` uses the LibreOffice + PdfPig composite parser. Switching `OCR` to `SIMPLE` reverts to the stub implementation.

## Monitoring & Troubleshooting

- `GET /health` – comprehensive health check (Postgres and Redis)
- `GET /health/basic` – lightweight "is the API running" check
- `GET http://localhost:5084/health` – spaCy service status (includes Redis queue lengths)
- Inspect Redis queues with Redis Commander at `http://localhost:8081` (launched via Docker Compose)
- Database artifacts land in PostgreSQL (default port `5433`) with two primary tables: `staging_documents` and `documents` (embedding column uses pgvector)

## spaCy Service Notes

- Loads the `en_core_web_sm` model by default; update `SPACY_MODEL` in `.env` to change models
- Supports entity extraction, simple classification, key phrases, sentiment, language detection, and embeddings
- Includes a Redis-backed worker (`workers/redis_consumer.py`) for async processing, though the main API currently performs synchronous HTTP calls to `/api/v1/process`

## Roadmap & Known Gaps

- End-to-end tests are minimal; integration coverage is a priority
- Authentication/authorization is not yet implemented
- Email notifications use SMTP stubs and require configuration before becoming functional
- Audio transcription, archive expansion, and chunked similarity search are planned next
- Frontend toasts and richer status feedback are planned to improve upload UX

## Contributing

1. Ensure you can run the API locally with the spaCy service active.
2. Prefer small, focused PRs that include tests or docs.
3. Run the quick verification steps before opening a PR:

```powershell
cd Server
dotnet build
dotnet test
```

Thank you for helping turn raw documents into structured intelligence!
